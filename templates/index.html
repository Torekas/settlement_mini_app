{% extends "base.html" %}
{% block title %}Kalkulator rozliczeń - Strona główna{% endblock %}
{% block content %}

<!-- Powiadomienia -->
{% if errors %}
  <div class="alert alert-danger text-center mt-3">{{ errors }}</div>
{% endif %}

<!-- Ustawienia walut i kursów -->
<div class="card shadow">
  <div class="card-header">
    <i class="fa-solid fa-coins"></i> Ustawienia walut i kursów (dla aktywnego wyjazdu)
  </div>
  <div class="card-body">
    <form method="post" class="row g-2 align-items-end mb-2">
      <div class="col-md-4">
        <label class="form-label">Waluta główna:</label>
        <select name="main_currency" class="form-select">
          {% for cur in available_currencies %}
            <option value="{{ cur }}" {% if cur == main_currency %}selected{% endif %}>{{ cur }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" name="action" value="set_main_currency" class="btn btn-primary w-100">Ustaw jako główną</button>
      </div>
      <div class="form-text">zmiany dotyczą tylko: <b>{{ active_trip.name }}</b></div>
    </form>
    <form method="post" class="row g-2 align-items-end mb-1">
      <div class="col-md-3">
        <label class="form-label">Nowa waluta:</label>
        <select name="currency_code" class="form-select">
          {% for cur in supported_currencies %}
            <option value="{{ cur }}">{{ cur }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Kurs (ile 1 {{ main_currency }} = ? wybranej):</label>
        <input type="text" name="currency_value" class="form-control" placeholder="np. 4.32">
      </div>
      <div class="col-md-2">
        <button type="submit" name="action" value="set_rate" class="btn btn-success w-100">Dodaj/zmień kurs</button>
      </div>
    </form>
    <div class="mt-3">
      <b>Twoje kursy walut:</b>
      <table class="table table-bordered table-sm align-middle" style="max-width: 400px;">
        <thead>
          <tr><th>Waluta</th><th>Kurs</th><th></th></tr>
        </thead>
        <tbody>
          {% for cur, val in currency_rates.items() %}
          <tr>
            <td>{{ cur }}</td>
            <td>{{ val }}</td>
            <td>
              {% if cur != main_currency %}
              <form method="post" style="display:inline;">
                <input type="hidden" name="del_currency_code" value="{{ cur }}">
                <button type="submit" name="action" value="del_rate" class="btn btn-sm btn-danger icon-btn" title="Usuń">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- WYBÓR WYJAZDU / ZARZĄDZANIE -->
<div class="card shadow mt-3">
  <div class="card-header">
    <i class="fa-solid fa-suitcase-rolling"></i> Wyjazdy
  </div>
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-5">
        <label class="form-label">Aktywny wyjazd:</label>
        <form method="post" class="input-group">
          <select name="trip_id" class="form-select">
            {% for t in non_archived_trips %}
              <option value="{{ t._id_str }}" {% if active_trip_id == t._id_str %}selected{% endif %}>
                {{ t.name }}{% if t.description %} — {{ t.description }}{% endif %}
              </option>
            {% endfor %}
          </select>
          <button type="submit" name="action" value="switch_trip" class="btn btn-outline-secondary">Przełącz</button>
        </form>
        <div class="form-text mt-1">transakcje poniżej dotyczą wyłącznie aktywnego wyjazdu</div>
      </div>
      <div class="col-md-5">
        <label class="form-label">Nowy wyjazd:</label>
        <form method="post" class="row g-2">
          <div class="col-md-6">
            <input type="text" name="trip_name" class="form-control" placeholder="np. Norwegia 2025">
          </div>
          <div class="col-md-6">
            <input type="text" name="trip_desc" class="form-control" placeholder="opis (opcjonalnie)">
          </div>
          <div class="col-12">
            <button type="submit" name="action" value="create_trip" class="btn btn-primary">
              <i class="fa-solid fa-plus"></i> Utwórz i ustaw
            </button>
          </div>
        </form>
      </div>
      <div class="col-md-2">
        <label class="form-label d-block">Archiwizacja:</label>
        <form method="post">
          <input type="hidden" name="trip_id" value="{{ active_trip_id }}">
          <button type="submit" name="action" value="archive_trip" class="btn btn-warning w-100">
            <i class="fa-solid fa-box-archive"></i> Archiwizuj aktywny
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Dodawanie / edycja transakcji -->
<div class="card shadow">
  <div class="card-header">
    <i class="fa-solid fa-plus"></i> {% if edit_transaction %} Edytuj transakcję {% else %} Dodaj transakcję {% endif %}
  </div>
  <div class="card-body">
    <form method="post" enctype="multipart/form-data" class="row g-3">
      <div class="col-md-3">
        <label for="payer" class="form-label">Płatnik</label>
        <input type="text" class="form-control" id="payer" name="payer"
               value="{{ edit_transaction.payer if edit_transaction }}" required>
      </div>
      <div class="col-md-3">
        <label for="amount" class="form-label">Kwota</label>
        <input type="text" class="form-control" id="amount" name="amount"
               value="{{ edit_transaction.amount if edit_transaction }}" required placeholder="np. 123.45">
      </div>
      <div class="col-md-3">
        <label for="currency" class="form-label">Waluta</label>
        <select class="form-select" id="currency" name="currency">
          {% for cur in available_currencies %}
            <option value="{{ cur }}" {% if edit_transaction and edit_transaction.currency == cur %}selected{% endif %}>{{ cur }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label for="beneficiaries" class="form-label">Beneficjenci (oddzieleni przecinkiem)</label>
        <input type="text" class="form-control" id="beneficiaries" name="beneficiaries"
               value="{% if edit_transaction %}{{ edit_transaction.beneficiaries | join(', ') }}{% endif %}"
               required placeholder="np. Jan, Anna, Ola">
      </div>
      <div class="col-12">
        <label for="description" class="form-label">Opis (opcjonalnie)</label>
        <textarea class="form-control" id="description" name="description" rows="2">{{ edit_transaction.description if edit_transaction }}</textarea>
      </div>
      <div class="col-12">
        {% if edit_transaction %}
          <input type="hidden" name="id" value="{{ edit_transaction.id }}">
          <button type="submit" name="action" value="update" class="btn btn-warning"><i class="fa-solid fa-check"></i> Zaktualizuj</button>
          <a href="{{ url_for('index') }}" class="btn btn-secondary"><i class="fa-solid fa-xmark"></i> Anuluj</a>
        {% else %}
          <button type="submit" name="action" value="add" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Dodaj transakcję</button>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<!-- Lista transakcji -->
<div class="card shadow">
  <div class="card-header">
    <i class="fa-solid fa-list"></i> Lista transakcji
  </div>
  <div class="card-body">
    {% if transactions %}
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>#</th><th>Płatnik</th><th>Kwota</th><th>Waluta</th><th>Beneficjenci</th><th>Opis</th><th>Operacje</th>
          </tr>
        </thead>
        <tbody>
          {% for tx in transactions %}
          <tr>
            <td>{{ loop.index0 }}</td>
            <td>{{ tx.payer }}</td>
            <td>{{ "%.2f"|format((tx.amount|default(0)|string).replace(',', '.')|float) }}</td>
            <td>{{ tx.currency }}</td>
            <td>{{ tx.beneficiaries | join(', ') }}</td>
            <td>{{ tx.description }}</td>
            <td>
              <form method="post" class="d-inline">
                <input type="hidden" name="id" value="{{ tx.id }}">
                <button type="submit" name="action" value="edit" class="btn btn-sm btn-info icon-btn" title="Edytuj"><i class="fa-solid fa-pen"></i></button>
              </form>
              <form method="post" class="d-inline">
                <input type="hidden" name="id" value="{{ tx.id }}">
                <button type="submit" name="action" value="delete" class="btn btn-sm btn-danger icon-btn" title="Usuń"><i class="fa-solid fa-trash"></i></button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-center">Brak transakcji</p>
    {% endif %}
  </div>
</div>

<!-- Akcje: oblicz, reset, import/export itd. -->
<div class="card shadow">
  <div class="card-header"><i class="fa-solid fa-calculator"></i> Działania</div>
  <div class="card-body">
    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <form method="post" class="d-inline">
          <button type="submit" name="action" value="calculate" class="btn btn-success"><i class="fa-solid fa-equals"></i> Oblicz rozliczenie</button>
        </form>
      </div>
      <div class="col-auto">
        <form method="post" class="d-inline">
          <button type="submit" name="action" value="reset" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i> Resetuj transakcje</button>
        </form>
      </div>
      <div class="col-auto">
        <!-- JSON download -->
        <form method="post" action="{{ url_for('download_json') }}" class="d-inline">
          <div class="input-group">
            <select name="download_currency" class="form-select" style="max-width: 100px;">
              {% for cur in available_currencies %}
                <option value="{{ cur }}" {% if cur == download_currency %}selected{% endif %}>{{ cur }}</option>
              {% endfor %}
            </select>
            <button type="submit" class="btn btn-secondary"><i class="fa-solid fa-file-arrow-down"></i> Pobierz JSON</button>
          </div>
        </form>
        <!-- HTML report download -->
        <form method="get" action="{{ url_for('download_report') }}" class="d-inline ms-2">
          <button type="submit" class="btn btn-outline-primary"><i class="fa-solid fa-file-code"></i> Pobierz HTML</button>
        </form>
      </div>
    </div>
    <div class="row g-2 align-items-center mt-3">
      <div class="col-md-6">
        <form method="post" enctype="multipart/form-data" class="input-group">
          <input type="file" class="form-control" id="import_file" name="import_file" accept=".json" required>
          <button type="submit" name="action" value="import" class="btn btn-primary"><i class="fa-solid fa-file-arrow-up"></i> Wczytaj plik</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Podsumowanie noclegów -->
<div class="card shadow" style="background: #f8fafb;">
  <div class="card-header">
    <i class="fa-solid fa-bed"></i> Podsumowanie noclegów
  </div>
  <div class="card-body">
    {% if lodging_summary %}
      <table class="table table-bordered">
        <thead class="table-light"><tr><th>Osoba</th><th>Kwota za noclegi ({{ main_currency }})</th></tr></thead>
        <tbody>
          {% for person, total in lodging_summary.items() %}
          <tr>
            <td>{{ person }}</td>
            <td>{{ "%.2f"|format((total|default(0)|string).replace(',', '.')|float) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-center">Brak transakcji z opisem "nocleg".</p>
    {% endif %}
  </div>
</div>

<!-- Szczegółowe rozliczenie -->
<div class="card shadow" style="background: #f8fafb;">
  <div class="card-header">
    <i class="fa-solid fa-chart-simple"></i> Szczegóły kosztów
  </div>
  <div class="card-body">
    {% if detailed_settlement %}
      <table class="table table-bordered">
        <thead class="table-light"><tr><th>Osoba</th><th>Wpłacone ({{ main_currency }})</th><th>Udział</th><th>Saldo netto</th></tr></thead>
        <tbody>
          {% for person, d in detailed_settlement.items() %}
          <tr>
            <td>{{ person }}</td>
            <td>{{ "%.2f"|format((d.paid|default(0)|string).replace(',', '.')|float) }}</td>
            <td>{{ "%.2f"|format((d.owes|default(0)|string).replace(',', '.')|float) }}</td>
            <td>
              <span class="{% if d.net < 0 %}text-danger{% elif d.net > 0 %}text-success{% endif %}">
                {{ "%.2f"|format((d.net|default(0)|string).replace(',', '.')|float) }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-center">Brak danych.</p>
    {% endif %}
  </div>
</div>

<!-- Spłaty (transfery redukujące długi) -->
<div class="card shadow" style="background:#f8fafb;">
  <div class="card-header">
    <i class="fa-solid fa-hand-holding-dollar"></i> Spłaty
  </div>
  <div class="card-body">
    <form method="post" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Dłużnik (od kogo)</label>
        <input type="text" class="form-control" name="rep_from" placeholder="np. Janek" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Wierzyciel (do kogo)</label>
        <input type="text" class="form-control" name="rep_to" placeholder="np. Wiktoria" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Kwota</label>
        <input type="text" class="form-control" name="rep_amount" placeholder="np. 150.00" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Waluta</label>
        <select name="rep_currency" class="form-select">
          {% for cur in available_currencies %}
            <option value="{{ cur }}" {% if cur == main_currency %}selected{% endif %}>{{ cur }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-8">
        <label class="form-label">Notatka (opcjonalnie)</label>
        <input type="text" class="form-control" name="rep_note" placeholder="np. przelew 12.11">
      </div>
      <div class="col-md-4">
        <button type="submit" name="action" value="add_repayment" class="btn btn-success w-100">
          <i class="fa-solid fa-plus"></i> Dodaj spłatę
        </button>
      </div>
    </form>

    <hr>

    {% if repayments %}
      <table class="table table-bordered table-hover mt-2">
        <thead class="table-light">
          <tr>
            <th>#</th><th>Od</th><th>Do</th><th>Kwota</th><th>Waluta</th><th>Notatka</th><th>Data</th><th></th>
          </tr>
        </thead>
        <tbody>
          {% for r in repayments %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ r.from }}</td>
            <td>{{ r.to }}</td>
            <td>{{ "%.2f"|format((r.amount|default(0)|string).replace(',', '.')|float) }}</td>
            <td>{{ r.currency }}</td>
            <td>{{ r.note }}</td>
            <td>{% if r.created_at %}{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}{% else %}—{% endif %}</td>
            <td>
              <form method="post" class="d-inline">
                <input type="hidden" name="rep_id" value="{{ r.id }}">
                <button type="submit" name="action" value="delete_repayment" class="btn btn-sm btn-danger icon-btn" title="Usuń">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if repayments_leftover and repayments_leftover|length > 0 %}
        <div class="alert alert-warning mt-2">
          <b>uwaga:</b> wykryto nadpłaty spłat względem bieżących długów par:
          <ul class="mb-0">
            {% for pair, val in repayments_leftover.items() %}
              {% set deb = pair[0] %}{% set cred = pair[1] %}
              <li>{{ deb }} → {{ cred }}: nadpłacone {{ "%.2f"|format((val|string).replace(',', '.')|float) }} {{ main_currency }}</li>
            {% endfor %}
          </ul>
          (nie rozdzielamy nadpłat automatycznie na innych wierzycieli)
        </div>
      {% endif %}

    {% else %}
      <p class="text-center mb-0">brak zarejestrowanych spłat.</p>
    {% endif %}
  </div>
</div>


<!-- Macierz rozliczeń -->
{% if settlement_matrix %}
<div class="card shadow" style="background: #f8fafb;">
  <div class="card-header">
    <i class="fa-solid fa-table"></i> Macierz rozliczeń (po uwzględnieniu spłat)
  </div>
  <div class="card-body">
    {% if negatives and positives %}
      <table class="table table-bordered">
        <thead class="table-light">
          <tr><th>Dłużnik \ Kredytor</th>{% for pos in positives %}<th>{{ pos }}</th>{% endfor %}</tr>
        </thead>
        <tbody>
          {% for neg in negatives %}
          <tr>
            <td>{{ neg }}</td>
            {% for pos in positives %}
            <td>
              {% set cell = (settlement_matrix[neg][pos] if settlement_matrix[neg][pos] is defined else 0) %}
              {% set key = neg ~ '|' ~ pos %}
              <div class="d-flex align-items-center justify-content-between gap-2">
                <span>{{ "%.2f"|format((cell|string).replace(',', '.')|float) }}</span>
                {% if repayments_leftover_map and repayments_leftover_map.get(key) %}
                  <span class="badge text-bg-warning" title="nadpłata względem długu pary">
                    +{{ "%.2f"|format((repayments_leftover_map.get(key)|string).replace(',', '.')|float) }}
                  </span>
                {% endif %}
              </div>
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-center">Brak danych do macierzy.</p>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- ARCHIWUM WYJAZDÓW -->
<div class="card shadow mt-3" style="background:#fcfcfd;">
  <div class="card-header">
    <i class="fa-solid fa-archive"></i> Archiwum wyjazdów
  </div>
  <div class="card-body">
    {% if archived_trips %}
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Nazwa</th>
            <th>Opis</th>
            <th>Zarchiwizowano</th>
            <th>Operacje</th>
          </tr>
        </thead>
        <tbody>
          {% for t in archived_trips %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ t.name }}</td>
            <td>{{ t.description }}</td>
            <td>
              {% if t.archived_at %}
                {{ t.archived_at.strftime('%Y-%m-%d %H:%M') }}
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              <form method="post" class="d-inline">
                <input type="hidden" name="trip_id" value="{{ t._id_str }}">
                <button type="submit" name="action" value="restore_trip" class="btn btn-sm btn-success">
                  <i class="fa-solid fa-rotate-left"></i> Przywróć
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-center mb-0">brak zarchiwizowanych wyjazdów</p>
    {% endif %}
  </div>
</div>

{% endblock %}
